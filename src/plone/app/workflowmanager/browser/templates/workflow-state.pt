<div class="workflow-state collasped workflow-item" 
    tal:attributes="id string:state-${state/id}"
    tal:define="state options/state;
                available_transitions options/available_transitions">

    <h3 class="header">
        <span class="arrow">&#x2193;</span>
        <span class="initial-state" tal:condition="python: view.selected_workflow.initial_state == state.id">*</span>
        <tal:nothing tal:replace="python: state.title">Title</tal:nothing> 
        <span class="arrow-to-transitions">&#x2192;</span>
        
        <span class="transitions goes-to">
        <tal:used-transitions tal:repeat="transition python: view.get_transition_list(state)">
          <a tal:attributes="href python: view.get_url(transition=transition)" tal:content="transition/title" class="goto-link" /><tal:comma tal:omit-tag="" tal:condition="not: repeat/transition/end">,</tal:comma>
        </tal:used-transitions>
        </span>
        <a class="dialog-box delete" rel="#pb_99999"
            tal:attributes="href python: view.get_url('@@workflowmanager-delete-state', state=state);">
            <input type="submit" class="standalone allowMultiSubmit" tal:attributes="name string:state-${state/id}-delete-button" value="Delete" />
        </a>
    </h3>

    <div class="hidden-content"
        tal:define="selected_transitions python: state.getTransitions()">

        <form method="POST" 
    	     tal:attributes="action string:${context/absolute_url}/@@workflowmanager-save-state">
	        <input type="hidden" name="selected-state" tal:attributes="value state/id">
          <input type="hidden" name="selected-workflow" tal:attributes="value view/selected_workflow/id" />
            
            <div class="selected-transitions item-properties">
            <fieldset>
                <legend>Transitions</legend>
                <p class="discreet">Transitions this state can use.</p>
                
                <tal:transitions tal:repeat="transition available_transitions">
                <div class="widget"
                    tal:define="field_name string:transition-${transition/id}-state-${state/id};
                                checked python: transition.id in selected_transitions">
                    <input type="checkbox" value="on"
                        tal:attributes="name field_name; 
                                        id field_name; 
                                        value python: checked and 'on' or '';
                                        checked python: checked and 'checked' or '';"
                        class="checkboxType" />
                     
                    <label 
                        tal:attributes="for field_name" 
                        tal:content="transition/title">
                        Transition Title
                    </label>
                </div>
                </tal:transitions>
                
                <a class="dialog-box save-first" rel="#pb_99999"
                    tal:attributes="href python: view.get_url('@@workflowmanager-add-new-transition', reference=state.id);">
                    <input type="button" class="context" name="add-new-transition-in-state-button" value="Add transition" />
                </a>
            
            </fieldset>
            </div>
            <div class="state-properties item-properties">
                <fieldset>
                    <legend>Properties</legend>
                    <div class="field"
                        tal:define="field_name string:state-${state/id}-initial-state;
                                    checked python: state.id == view.selected_workflow.initial_state;">
                        <div class="widget">
                            <input type="checkbox" 
                                tal:attributes="name field_name; 
                                                id field_name; 
                                                value python: checked and 'on' or '';
                                                checked python: checked and 'checked' or '';"
                                class="checkboxType" />
                            <label tal:attributes="for field_name">
                                Initial State
                            </label>
                            <div class="formHelp">
                                Should this state be the initial state of the workflow?
                            </div>
                        </div>
                    </div>
                    <div class="field" tal:define="field_name string:state-${state/id}-title">

                        <label tal:attributes="name field_name">Title</label>
                        <div class="formHelp">
                            The title of this State.
                        </div>

                        <input type="text" size="25" tal:attributes="name field_name; value state/title;" />
                    </div>
                    
                    <div class="field" tal:define="field_name string:state-${state/id}-description">

                        <label tal:attributes="name field_name">Description</label>
                        <div class="formHelp">
                            The description of this State.
                        </div>

                        <textarea cols="30" rows="3" tal:attributes="name field_name;" tal:content="state/description">
                        </textarea>
                    </div>
                    
                </fieldset>
            </div>
            
            <div class="state-permissions item-properties">
                <fieldset>
                    <legend>Permission Roles</legend>
                    <p class="discreet">Permissions these roles have in this state.</p>
                    <table summary="State Permissions" class="listing" tal:attributes="id string:state-${state/id}-permissions">
                        <tbody id="state-permissions-settings">

                          <tr class="odd">
                            <th rowspan="2">Roles</th>
                            <th tal:attributes="colspan python: len(view.managed_permissions)">Permissions</th>
                          </tr>
                            
                          <tr class="odd">
                            <tal:managed-permissions tal:repeat="perminfo view/managed_permissions">
                            <th class="nosort">
                              <span tal:content="perminfo/name" class="tooltip"/>
                              <div class="tooltip-contents">
                                <dl>
                                  <dt tal:content="string:${perminfo/perm}">Permission</dt>
                                  <dd tal:content="string:${perminfo/description}">Definition</dd>
                                </dl>
                              </div>
                            </th>
                            </tal:managed-permissions>
                          </tr>
                          
                            <tal:roles tal:repeat="role view/selected_workflow/getAvailableRoles">
                            <tr class="even" tal:define="oddrow repeat/role/odd;"
                                  tal:attributes="class python: oddrow and 'odd' or 'even'">
                                <td>
                                    <tal:content tal:replace="role" />
                                    <input type="hidden" value="AuthenticatedUsers" name="entries.id:records">
                                    <input type="hidden" value="group" name="entries.type:records">
                                </td>
                            
                                <tal:permissions tal:repeat="perminfo view/managed_permissions">
                                <td class="listingCheckbox" 
                                    tal:define="info python: state.getPermissionInfo(perminfo['perm']);
                                                checked python: role in info['roles'];">
                                    <input type="checkbox"
                                        tal:attributes="name python: 'permission-%s-role-%s-state-%s' % (perminfo['name'], role, state.id);
                                                        checked python: checked and 'checked' or '';
                                                        value python: checked and 'on' or '';" 
                                        value="True" class="noborder" />

                                </td>
                                </tal:permissions>
                            </tr>
                            </tal:roles>
                        </tbody>
                    </table>
                </fieldset>
            </div>
            <div class="state-group-roles item-properties advanced">
                <fieldset>
                    <legend>Group Roles</legend>
                    <p class="discreet">The local role that are assigned to these groups in this state.</p>
                    <table summary="State Group Roles" class="listing" tal:attributes="id string:state-${state/id}-group-roles">
                        <tbody id="state-group-roles-settings"
                          tal:define="groups view/getGroups">
                          <tr class="odd">
                            <th rowspan="2">Roles</th>
                            <th tal:attributes="colspan python: len(groups)">Groups</th>
                          </tr>
                          <tr class="odd">
                            <tal:managed-permissions tal:repeat="group groups">
                              <th class="nosort" tal:content="group/id"></th>
                            </tal:managed-permissions>
                          </tr>
                          
                          <tal:roles tal:repeat="role view/selected_workflow/getAvailableRoles">
                          <tr tal:define="oddrow repeat/role/odd;"
                              tal:attributes="class python: oddrow and 'odd' or 'even'">
                              <td>
                                  <tal:content tal:replace="role" />
                                  <input type="hidden" value="AuthenticatedUsers" name="entries.id:records">
                                  <input type="hidden" value="group" name="entries.type:records">
                              </td>
                          
                              <tal:permissions tal:repeat="group groups">
                              <td class="listingCheckbox" 
                                  tal:define="info python: state.getGroupInfo(group['id']);
                                              checked python: role in info;">
                                  <input type="checkbox" 
                                      tal:attributes="name python: 'group-%s-role-%s-state-%s' % (group['id'], role, state.id);
                                                      checked python: checked and 'checked' or '';
                                                      value python: checked and 'on' or ''" 
                                      value="True" class="noborder" />

                              </td>
                              </tal:permissions>
                          </tr>
                          </tal:roles>
                        </tbody>
                    </table>
                </fieldset>
            </div>
            <br />
            <div class="formControls">
              <noscript>
                <input type="submit" class="inline context allowMultiSubmit" value="Save state" 
                  tal:attributes="name string:save-state-${state/id}-button" />
              </noscript>
            </div>            
        </form>
    </div>
    
</div>
